map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
map $http_host $this_host {
    "" $host;
    default $http_host;
}
map $http_x_forwarded_proto $the_scheme {
     default $http_x_forwarded_proto;
     "" $scheme;
}
map $http_x_forwarded_host $the_host {
    default $http_x_forwarded_host;
    "" $this_host;
}

server_names_hash_bucket_size 512;
client_header_buffer_size 32k;
large_client_header_buffers 4 32k;
client_max_body_size 50m;

server {
    listen 80;
    include /etc/nginx/conf.d/site/*.conf;
    root /var/www/public;
    autoindex off;
    index index.html index.htm index.php;
    charset utf-8;

            location / {
                    try_files $uri $uri/ /index.html;
                    index index.html index.htm;
            }

            location /api/ {
                    proxy_pass   http://jmalcloud:8088/;
                    proxy_set_header Host $proxy_host;
                    proxy_set_header X-real-ip $remote_addr;
            }

            location /file/ {
                    proxy_pass  http://jmalcloud:8088/file/;
                    proxy_http_version 1.1;
                    proxy_set_header X-real-ip $remote_addr;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Real-PORT $remote_port;
                    proxy_set_header X-Forwarded-Host $the_host/file;
                    proxy_set_header X-Forwarded-Proto $the_scheme;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header Host $http_host;
                    proxy_set_header Scheme $scheme;
                    proxy_set_header Server-Protocol $server_protocol;
                    proxy_set_header Server-Name $server_name;
                    proxy_set_header Server-Addr $server_addr;
                    proxy_set_header Server-Port $server_port;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection $connection_upgrade;
            }

            location /mq {
                    proxy_pass   http://jmalcloud:8088/mq/;
                    #websocket额外配置开始
    			    proxy_http_version 1.1;
    			    proxy_set_header Upgrade $http_upgrade;
    			    proxy_set_header Connection "upgrade";
    			    proxy_connect_timeout 60s;#l连接超时时间，不能设置太长会浪费连接资源
    	            proxy_read_timeout 500s;#读超时时间
    	            proxy_send_timeout 500s;#写超时时间
                    #websocket额外配置结束
            }

            location /office {
                    proxy_pass  http://office/;
                    proxy_http_version 1.1;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Real-PORT $remote_port;
                    proxy_set_header X-Forwarded-Host $the_host/office;
                    proxy_set_header X-Forwarded-Proto $the_scheme;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header Host $http_host;
                    proxy_set_header Scheme $scheme;
                    proxy_set_header Server-Protocol $server_protocol;
                    proxy_set_header Server-Name $server_name;
                    proxy_set_header Server-Addr $server_addr;
                    proxy_set_header Server-Port $server_port;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection $connection_upgrade;
            }

            location /drawio/webapp/ {
               proxy_pass http://drawio-webapp:8080/;
               proxy_http_version 1.1;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Real-PORT $remote_port;
               proxy_set_header X-Forwarded-Host $the_host/drawio/webapp;
               proxy_set_header X-Forwarded-Proto $the_scheme;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header Host $http_host;
               proxy_set_header Scheme $scheme;
               proxy_set_header Server-Protocol $server_protocol;
               proxy_set_header Server-Name $server_name;
               proxy_set_header Server-Addr $server_addr;
               proxy_set_header Server-Port $server_port;
               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection $connection_upgrade;
           }

}

        server {
        	listen 8089;
        	server_name jmalcloud;

                location = / {
                        proxy_pass   http://jmalcloud:8088/articles;
                        proxy_set_header Host $proxy_host;
                        proxy_set_header X-real-ip $remote_addr;
                }

                location /api {
                                proxy_pass   http://jmalcloud:8088;
                                proxy_set_header Host $proxy_host;
                                proxy_set_header X-real-ip $remote_addr;
                        }

                location /articles/articles {
                        proxy_pass   http://jmalcloud:8088/articles;
                        proxy_set_header Host $proxy_host;
                        proxy_set_header X-real-ip $remote_addr;
                }

        	    location /articles {
                        proxy_pass   http://jmalcloud:8088/articles;
                        proxy_set_header Host $proxy_host;
                        proxy_set_header X-real-ip $remote_addr;
                }

                location / {
                        proxy_pass   http://jmalcloud:8088/articles/;
                        proxy_set_header Host $proxy_host;
                        proxy_set_header X-real-ip $remote_addr;
                }

        }

include /etc/nginx/conf.d/conf.d/*.conf;
